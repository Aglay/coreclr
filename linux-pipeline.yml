parameters:
  buildConfig: ''
  buildConfigUpper: ''
  archType: ''

jobs:

### Product build
- template: /eng/common/templates/phases/base.yml@arcade
  parameters:
    name: ${{ format('linux_{0}_{1}_build', parameters.archType, parameters.buildConfig) }}
    displayName: ${{ format('Linux {0} {1} Build', parameters.archType, parameters.buildConfigUpper) }}
    queue:
      name: Hosted Ubuntu 1604
      timeoutInMinutes: 180
    agentOs: Ubuntu
    variables:
      buildConfig: ${{ parameters.buildConfig }}
      buildConfigUpper: ${{ parameters.buildConfigUpper }}
      archType: ${{ parameters.archType }}
    steps:
    - script: sudo apt install cmake llvm-3.9 clang-3.9 lldb-3.9 liblldb-3.9-dev libunwind8 libunwind8-dev gettext libicu-dev liblttng-ust-dev libcurl4-openssl-dev libssl-dev libkrb5-dev libnuma-dev
      displayName: Install native dependencies
#    - task: DotNetCoreInstaller@0
#      inputs:
#        version: 2.1.400
#    - script: bash ./eng/common/init-tools-native.sh --installdirectory $(Agent.BuildDirectory)/native-tools -Force
#      displayName: Install native tools
    - script: ./init-tools.sh
      displayName: Init tools
    - script: ./Tools/dotnetcli/dotnet msbuild build.proj /p:RestoreDuringBuild=true /t:Sync
      displayName: Sync
    - script: ./build.sh $(buildConfig) $(archType) -skipnuget -skiprestore
      displayName: Build

    # Upload build as pipeline artifact
    - task: PublishPipelineArtifact@0
      inputs:
        targetPath: $(Build.SourcesDirectory)/bin/Product/Linux.$(archType).$(buildConfigUpper)

    - ${{ if and(ne(variables['System.TeamProject'], 'public'), notin(variables['Build.Reason'], 'PullRequest')) }}:
      - script: echo Sign!
        displayName: Sign Binaries (empty for now)

    # Get key vault secrets for publishing
    - ${{ if and(ne(variables['System.TeamProject'], 'public'), notin(variables['Build.Reason'], 'PullRequest')) }}:
      - task: AzureKeyVault@1
        inputs:
          azureSubscription: 'DotNet-Engineering-Services_KeyVault'
          KeyVaultName: EngKeyVault
          SecretsFilter: 'dotnetfeed-storage-access-key-1,microsoft-symbol-server-pat,symweb-symbol-server-pat'

    # Publish official builds
    # - script: echo Publish!
    #   displayName: Publish build to some location (empty for now)


### Test build and run
- template: /eng/common/templates/phases/base.yml@arcade
  parameters:
    name: ${{ format('linux_{0}_{1}_test', parameters.archType, parameters.buildConfig) }}
    displayName: ${{ format('Linux {0} {1} Test Build and Run', parameters.archType, parameters.buildConfigUpper) }}
    queue:
      name: Hosted Ubuntu 1604
      timeoutInMinutes: 180
    agentOs: Ubuntu
    variables:
      buildConfig: ${{ parameters.buildConfig }}
      buildConfigUpper: ${{ parameters.buildConfigUpper }}
      archType: ${{ parameters.archType }}
    steps:
    - script: sudo apt install cmake llvm-3.9 clang-3.9 lldb-3.9 liblldb-3.9-dev libunwind8 libunwind8-dev gettext libicu-dev liblttng-ust-dev libcurl4-openssl-dev libssl-dev libkrb5-dev libnuma-dev
    - script: ./build-test.sh $(buildConfig) $(archType)
      displayName: Build tests
    - script: ./Tools/dotnetcli/dotnet msbuild tests/helixprep.proj /p:CORE_ROOT=$(Build.SourcesDirectory)/bin/tests/Linux.$(archType).$(buildConfigUpper)/Tests/Core_Root /p:__BuildType=$(buildConfig) /p:__BuildArch=$(archType)
      displayName: Prepare test directories for helix
    - task: DotNetCoreCLI@2
      inputs:
        command: custom
        projects: tests/helixpublishwitharcade.proj
        custom: msbuild
        arguments: '/t:test'
      displayName: Send tests job to Helix
      env:
        HelixAccessToken: $(HelixTestAccessToken)
