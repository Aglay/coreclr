<Project Sdk="Microsoft.DotNet.Helix.Sdk">

  <Import Project="..\dir.props" />

  <PropertyGroup>
    <HelixSource>pr/coreclr/master</HelixSource>
    <HelixType>test/stuff</HelixType>
    <HelixBuild>$(BUILD_BUILDNUMBER)</HelixBuild>
    <HelixTargetQueues>Windows.10.Amd64.Open;Windows.7.Amd64.Open;windows.10.arm64.open;Windows.81.Amd64.Open;fedora.27.amd64.open</HelixTargetQueues>
    <HelixTargetQueues Condition=" '$(BuildOS)' == 'Windows_NT' ">Windows.10.Amd64;Windows.10.Nano.Amd64;Windows.10.Amd64.Core;Windows.7.Amd64;Windows.81.Amd64</HelixTargetQueues>
    <HelixTargetQueues Condition=" '$(BuildOS)' == 'Linux' ">debian.82.amd64;fedora.27.amd64;fedora.28.amd64;redhat.73.amd64;ubuntu.1404.amd64;ubuntu.1604.amd64;ubuntu.1804.amd64;opensuse.423.amd64;sles.12.amd64</HelixTargetQueues>
    <HelixTargetQueues Condition=" '$(BuildOS)' == 'OSX' ">osx.1012.amd64;osx.1013.amd64</HelixTargetQueues>
    <EnableXUnitReporter>true</EnableXUnitReporter>
    <WaitForWorkItemCompletion>true</WaitForWorkItemCompletion>
    <SourceDirectory>$(MSBuildProjectDirectory)/..</SourceDirectory>
  </PropertyGroup>

  <ItemGroup>
    <HelixCorrelationPayload Include="$(SourceDirectory)\bin\tests\*\archive\Core_Root\*.zip">
      <PayloadArchive>%(Identity)</PayloadArchive>
    </HelixCorrelationPayload>
  </ItemGroup>

  <Target Name="BuildHelixWorkItem"
          BeforeTargets="Test">
    <ItemGroup>
      <TestZipFiles Include="$(SourceDirectory)\bin\tests\*\archive\tests\*.zip" />

      <HelixWorkItem Include="@(TestZipFiles->'%(FileName)')" >
        <PayloadArchive>%(Identity)</PayloadArchive>
        <Command Condition=" '$(OSEnvironment)' == 'Unix' ">./runtests.sh</Command>
        <Command Condition=" '$(OSEnvironment)' == 'Windows_NT' ">runtests.cmd</Command>
      </HelixWorkItem>
    </ItemGroup>
  </Target>

  <Target Name="PrintItems"
          AfterTargets="BuildHelixWorkItem">
    <Message Importance="High" Text="ZipFiles: @(ZipFiles)" />
    <Message Importance="High" Text="Identity: @(HelixWorkItem->'%(Identity)')" />
    <Message Importance="High" Text="PayloadArchive: @(HelixWorkItem->'%(PayloadArchive)')" />
    <Message Importance="High" Text="BuildOS: $(BuildOS), __BuildOs: $(__BuildOS), osenv: $(OSEnvironment)" />
    <Message Importance="High" Text="usingsdk: $(UsingMicrosoftNETSdk)" />
    <Message Importance="High" Text="targetqueues: $(HelixTargetQueues)" />
    <Message Importance="High" Text="osenv: $(OSEnvironment)" />
    <Message Importance="High" Text="command: @(HelixWorkItem->'%(Command)')" />
  </Target>
</Project>
